apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "fullname" . }}-config
  labels:
    app: {{ template "fullname" . }}
    chart: {{ .Chart.Name }}
    release: {{ template "releaseName" .  }}
    heritage: {{ .Release.Service }}
    component: {{ .Chart.Name }}
  annotations:
    version: "{{ .Chart.Version }}"
data:
  panel-overlay.config: {{ toYaml .Values.panelOverlayConfig }}
  worker-overlay.config: {{ toYaml .Values.workerOverlayConfig }}
  ONEZONE_CONFIG: |-
    cluster:
      domainName: "{{ template "service_url" . }}"
      nodes:
        {{- $r := . -}}
        {{- range $i := until (int (.Values.onezone_nodes_count)) }}
        n{{ $i }}: 
          hostname: {{ template "fullname" $r }}-{{ $i }}
        {{- end }}
      managers:
        mainNode: n{{ sub (.Values.onezone_nodes_count) 1 }} 
        nodes:
    {{- with .Values.cluster_config.managers }}
        {{- range $i := . }}
          - n{{ $i }}
        {{- end }}
    {{- else }}
        {{- range $i := until (int ($r.Values.onezone_nodes_count)) }}
          - n{{ $i }}
        {{- end }}
    {{- end }}
      workers:
        nodes:
    {{- with .Values.cluster_config.workers }}
        {{- range $i := . }}
          - n{{ $i }}
        {{- end }}
    {{- else }}
        {{- range $i := until (int ($r.Values.onezone_nodes_count)) }}
          - n{{ $i }}
        {{- end }}
    {{- end }}
      databases:
        nodes:
    {{- with .Values.cluster_config.databases }}
        {{- range $i := . }}
          - n{{ $i }}
        {{- end }}
    {{- else }}
        {{- range $i := until (int ($r.Values.onezone_nodes_count)) }}
          - n{{ $i }}
        {{- end }}
    {{- end }}
    onezone:
      {{ if .Values.name -}}
      name: {{ .Values.name }}
      {{- else -}}
      name: {{ template "fullname" . }}
      {{- end }}
      domainName: {{ template "service_url" . }}
    {{- if or .Values.onepanelAdminUsers .Values.onepanel_users }}
    onepanel:
      users:
        {{ .Values.onezone_main_admin.name }}:
          password: {{ .Values.onezone_main_admin.password }}
          userRole: admin
        {{- range .Values.onepanel_users }}
        {{- if (hasKey .idps "onepanel") }}{{- if (hasKey .idps.onepanel "mode" ) }}{{- if and .idps.onepanel.enabled (eq .idps.onepanel.mode "config") }}
        {{ .name }}:
          password: {{ .password }}
          userRole: {{ if .idps.onepanel.type -}}{{- .idps.onepanel.type -}}{{- else -}}regular{{- end -}}
        {{- end }}{{- end }}{{- end }}
        {{- end }}
    {{- end }}

  auth.config: |-
        %% Default auth.config file, only onepanelAuth login is enabled. Please refer
        %% to ./template.auth.config or Onedata documentation (https://onedata.org)
        %% for information how to fill out this config.

        #{
            version => 2,

            onepanelAuthConfig => #{
                enabled => true
            },

            samlConfig => #{
                enabled => false
            },

            openidConfig => #{
                enabled => false
            },

            supportedIdps => [
               {onepanel, #{
                    displayName => "Onepanel account",
                    iconPath => "/assets/images/auth-providers/onepanel.svg",
                    iconBackgroundColor => "#4BD187",
                    protocol => onepanelAuth
                }}
            ]
        }.

    
{{- if (index .Values "saml-idp" "enabled") }}
  saml.config: |-
    [].
{{- end }}